# ğŸ”„ AI RESPONSE DATA FLOW

## ğŸ“Š COMPLETE PIPELINE VISUALIZATION

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        USER UPLOADS PHOTOS                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              saveAuthenticatedScan.ts / flushPendingScan.ts      â”‚
â”‚  ğŸ“¤ Upload to Storage â†’ ğŸ”— Generate Signed URLs                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               CALL analyze-face Edge Function                    â”‚
â”‚  ğŸ“¤ Send: { front_image_url, side_image_url, age, sex }         â”‚
â”‚  ğŸ” LOG: [AI] Raw response from analyze-face                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    AI RETURNS RESPONSE                           â”‚
â”‚  {                                                               â”‚
â”‚    ok: true,                                                     â”‚
â”‚    data: {                                                       â”‚
â”‚      scores: {                                                   â”‚
â”‚        overall: 81,                                              â”‚
â”‚        skin_quality: 72,          â† snake_case                   â”‚
â”‚        jawline_definition: 68,                                   â”‚
â”‚        cheekbones: 75,                                           â”‚
â”‚        facial_symmetry: 80,                                      â”‚
â”‚        eye_area: 77,                                             â”‚
â”‚        potential: 93                                             â”‚
â”‚      },                                                          â”‚
â”‚      gender: "male"                                              â”‚
â”‚    }                                                             â”‚
â”‚  }                                                               â”‚
â”‚  ğŸ” LOG: [AI] Parsed response structure                         â”‚
â”‚  ğŸ” LOG: [AI] Scores being saved to database                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   SAVE TO DATABASE (scans table)                 â”‚
â”‚  scores_json: {                                                  â”‚
â”‚    overall: 81,                                                  â”‚
â”‚    skin_quality: 72,              â† Saved as-is (snake_case)     â”‚
â”‚    jawline_definition: 68,                                       â”‚
â”‚    ...                                                           â”‚
â”‚  }                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            CALL recommend-peptides Edge Function                 â”‚
â”‚  ğŸ“¤ Send: { scanId }                                             â”‚
â”‚  ğŸ” LOG: [AI] Raw response from recommend-peptides              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                PEPTIDES AI RETURNS RESPONSE                      â”‚
â”‚  {                                                               â”‚
â”‚    ok: true,                                                     â”‚
â”‚    recommended_peptides: [                                       â”‚
â”‚      {                                                           â”‚
â”‚        name: "GHK-Cu",                                           â”‚
â”‚        fit_score: 92,                                            â”‚
â”‚        tags: ["anti-aging", "collagen"],                         â”‚
â”‚        summary: "..."                                            â”‚
â”‚      },                                                          â”‚
â”‚      ...                                                         â”‚
â”‚    ]                                                             â”‚
â”‚  }                                                               â”‚
â”‚  ğŸ” LOG: [AI] Peptides count                                    â”‚
â”‚  ğŸ” LOG: [AI] Peptide 1, 2, 3...                                â”‚
â”‚  ğŸ” LOG: [AI] Final peptides to display                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         SAVE PEPTIDES TO DATABASE (scans table update)           â”‚
â”‚  peptide_recommendations: [ ... ]                                â”‚
â”‚  ğŸ” LOG: [AI] Peptides to save                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  USER VIEWS DASHBOARD                            â”‚
â”‚                      Dashboard.tsx                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              FETCH FROM DATABASE (scans table)                   â”‚
â”‚  SELECT id, scores_json, peptide_recommendations                â”‚
â”‚  ğŸ” LOG: [DASHBOARD] Fetching scans for user                    â”‚
â”‚  ğŸ” LOG: [AI] Raw scores_json from DB                           â”‚
â”‚  ğŸ” LOG: [AI] Cached peptides                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         NORMALIZE SCORES (normalizeScores.ts)                    â”‚
â”‚                                                                  â”‚
â”‚  INPUT (snake_case):           OUTPUT (camelCase):               â”‚
â”‚  {                             {                                 â”‚
â”‚    skin_quality: 72      â†’       skinQuality: 72                â”‚
â”‚    jawline_definition: 68 â†’      jawline: 68                    â”‚
â”‚    facial_symmetry: 80    â†’      symmetry: 80                   â”‚
â”‚    eye_area: 77          â†’       eyeArea: 77                    â”‚
â”‚  }                             }                                 â”‚
â”‚                                                                  â”‚
â”‚  ğŸ” LOG: [SCORES_RAW] Input                                     â”‚
â”‚  ğŸ” LOG: [SCORES_NORM] Output                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       DISPLAY IN UI (PaymentSuccessScreen.tsx)                  â”‚
â”‚                                                                  â”‚
â”‚  const scores = normalizeScores(scoresJson);                    â”‚
â”‚  const aspects = [                                              â”‚
â”‚    { label: "Skin Quality", score: scores.skinQuality },        â”‚
â”‚    { label: "Jawline", score: scores.jawline },                 â”‚
â”‚    ...                                                           â”‚
â”‚  ];                                                              â”‚
â”‚                                                                  â”‚
â”‚  UI Shows:                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                        â”‚
â”‚  â”‚ Overall: 81         â”‚                                        â”‚
â”‚  â”‚ Skin Quality: 72    â”‚                                        â”‚
â”‚  â”‚ Jawline: 68         â”‚                                        â”‚
â”‚  â”‚ ...                 â”‚                                        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                        â”‚
â”‚                                                                  â”‚
â”‚  ğŸ” LOG: [AI] Normalized scores for display                     â”‚
â”‚  ğŸ” LOG: [AI] UI will display                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    DISPLAY PEPTIDES (PeptideCardsSection.tsx)                   â”‚
â”‚                                                                  â”‚
â”‚  {recommendations.map(peptide => (                              â”‚
â”‚    <div>                                                         â”‚
â”‚      <h3>{peptide.name}</h3>                                     â”‚
â”‚      <span>{peptide.fit_score}% fit</span>                       â”‚
â”‚      <div>{peptide.tags.map(...)}</div>                          â”‚
â”‚      <p>{peptide.summary}</p>                                    â”‚
â”‚    </div>                                                        â”‚
â”‚  ))}                                                             â”‚
â”‚                                                                  â”‚
â”‚  UI Shows:                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                â”‚
â”‚  â”‚ GHK-Cu                      â”‚                                â”‚
â”‚  â”‚ 92% fit for you             â”‚                                â”‚
â”‚  â”‚ [anti-aging] [collagen]     â”‚                                â”‚
â”‚  â”‚ Summary text...             â”‚                                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                â”‚
â”‚                                                                  â”‚
â”‚  ğŸ” LOG: [AI] Rendering peptides in UI                          â”‚
â”‚  ğŸ” LOG: [AI] Rendering peptide card 1                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”‘ KEY POINTS

### Data Format Changes:
1. **AI Response** â†’ snake_case (e.g., `skin_quality`)
2. **Database Storage** â†’ snake_case (stored as-is)
3. **Normalized** â†’ camelCase (e.g., `skinQuality`)
4. **UI Display** â†’ Human readable (e.g., "Skin Quality: 72")

### Logging Checkpoints:
- âœ… After AI responds
- âœ… Before DB save
- âœ… After DB retrieval
- âœ… After normalization
- âœ… Before UI render

## ğŸ› DEBUGGING AT EACH STAGE

### Stage 1: AI Response
**Check:** `[AI] Raw response from analyze-face`
**Problem if:** `ok: false`, missing fields, or errors

### Stage 2: Database Save
**Check:** `[AI] Scores being saved to database`
**Problem if:** Fields missing or not saved

### Stage 3: Database Retrieval
**Check:** `[AI] Raw scores_json from DB`
**Problem if:** Different from what was saved

### Stage 4: Normalization
**Check:** `[SCORES_NORM] Output`
**Problem if:** Any values are null when DB has values

### Stage 5: Display
**Check:** `[AI] UI will display`
**Problem if:** Values don't match normalized scores

## ğŸ¯ TRACE A SINGLE FIELD

Example: Tracing "skin_quality" â†’ "Skin Quality: 72"

```
1. AI Response:
   [AI] Raw response: { scores: { skin_quality: 72 } }
   
2. Save to DB:
   [AI] Scores being saved: { skin_quality: 72 }
   
3. Retrieve from DB:
   [AI] Raw scores_json from DB: { skin_quality: 72 }
   
4. Normalize:
   [SCORES_RAW] Input: { skin_quality: 72 }
   [SCORES_NORM] Output: { skinQuality: 72 }
   
5. Display:
   [AI] Normalized scores: { skinQuality: 72 }
   [AI] UI will display: Skin Quality: 72
   
6. Render:
   <p>Skin Quality</p>
   <p>72</p>
```

## âœ… SUCCESS INDICATORS

All these logs should appear in sequence:
- [AI] Raw response from analyze-face âœ“
- [AI] Scores being saved to database âœ“
- [AI] Raw scores_json from DB âœ“
- [SCORES_NORM] Output âœ“
- [AI] UI will display âœ“
- [AI] Raw peptides response âœ“
- [AI] Rendering peptides in UI âœ“

If any log is missing â†’ That stage failed!
